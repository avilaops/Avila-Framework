import crypto from "crypto"; interface ServerEventParams { env: "dev" | "stg" | "prd"; account_id: string; persona?: string; vertical?: string; plan?: string; [key: string]: any; } export async function gaServerEvent(clientId: string, eventName: string, params: ServerEventParams) { const measurementId = process.env.GA4_MEASUREMENT_ID; const apiSecret = process.env.GA4_API_SECRET; if (!measurementId || !apiSecret) { console.error("GA4 credentials not configured"); return; } const payload = { client_id: clientId, events: [{ name: eventName, params: { ...params, engagement_time_msec: "100" } }] }; try { const response = await fetch(`https://www.google-analytics.com/mp/collect?measurement_id=${measurementId}&api_secret=${apiSecret}`, { method: "POST", body: JSON.stringify(payload) }); if (!response.ok) { console.error("GA4 server event failed:", response.status); } } catch (error) { console.error("GA4 server event error:", error); } } export function generateClientId(accountId: string): string { return crypto.createHash("sha256").update(`avila_${accountId}`).digest("hex").substring(0, 32); }