import { GA4EventName, GA4EventParams, GA4_IDS, Environment, UTMParams } from "./ga-types"; declare global { interface Window { gtag?: (command: string, target: string, config?: Record<string, any>) => void; } } function getGA4Id(): string { const env = (process.env.NEXT_PUBLIC_ENV || "dev") as Environment; return GA4_IDS[env]; } export function initGA4() { const measurementId = getGA4Id(); window.gtag?.("js", new Date()); window.gtag?.("config", measurementId, { send_page_view: false }); window.gtag?.("consent", "default", { ad_storage: "denied", analytics_storage: "denied", functionality_storage: "denied", personalization_storage: "denied", security_storage: "granted" }); } export function updateConsent(granted: boolean) { window.gtag?.("consent", "update", { analytics_storage: granted ? "granted" : "denied" }); } export function sendEvent(eventName: GA4EventName, params: GA4EventParams) { const measurementId = getGA4Id(); const utmParams = getUTMParams(); const finalParams = { ...params, ...utmParams, env: (process.env.NEXT_PUBLIC_ENV || "dev") as Environment }; window.gtag?.("event", eventName, { send_to: measurementId, ...finalParams }); } function getUTMParams() { const utm = getStoredUTM(); return { utm_source: utm.source || undefined, utm_medium: utm.medium || undefined, utm_campaign: utm.campaign || undefined, utm_content: utm.content || undefined, utm_term: utm.term || undefined }; } export function captureUTM() { if (typeof window === "undefined") return; const params = new URLSearchParams(window.location.search); const utm: UTMParams = {}; const source = params.get("utm_source"); const medium = params.get("utm_medium"); const campaign = params.get("utm_campaign"); const content = params.get("utm_content"); const term = params.get("utm_term"); if (source) utm.source = source; if (medium) utm.medium = medium; if (campaign) utm.campaign = campaign; if (content) utm.content = content; if (term) utm.term = term; if (Object.keys(utm).length > 0) { sessionStorage.setItem("avila_utm", JSON.stringify(utm)); } } export function getStoredUTM(): UTMParams { if (typeof window === "undefined") return {}; const stored = sessionStorage.getItem("avila_utm"); return stored ? JSON.parse(stored) : {}; }