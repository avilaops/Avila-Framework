name: Envio Autom√°tico de Relat√≥rios

on:
    schedule:
        # Relat√≥rio di√°rio: Segunda a Sexta √†s 8h UTC (5h Bras√≠lia)
        - cron: "0 8 * * 1-5"
        # Relat√≥rio semanal: Segundas √†s 9h UTC (6h Bras√≠lia)
        - cron: "0 9 * * 1"

    workflow_dispatch: # Permite execu√ß√£o manual
        inputs:
            recipient:
                description: "Email do destinat√°rio (opcional, usa TO_EMAIL do secret)"
                required: false
            report_type:
                description: "Tipo de relat√≥rio"
                required: true
                default: "diario"
                type: choice
                options:
                    - diario
                    - semanal
                    - mensal

jobs:
    send-report:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout c√≥digo
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Instalar depend√™ncias
              run: |
                  python -m pip install --upgrade pip
                  # Adicione aqui se precisar de libs extras no futuro
                  # pip install -r requirements.txt

            - name: Gerar dados do relat√≥rio
              run: |
                  # Aqui voc√™ pode adicionar scripts para buscar dados reais
                  # Por enquanto, usa os dados de exemplo em data/
                  echo "üìä Usando dados agregados de data/"

            - name: Enviar relat√≥rio di√°rio
              if: github.event.schedule == '0 8 * * 1-5' || github.event.inputs.report_type == 'diario'
              env:
                  SMTP_HOST: ${{ secrets.SMTP_HOST }}
                  SMTP_PORT: ${{ secrets.SMTP_PORT }}
                  SMTP_USER: ${{ secrets.SMTP_USER }}
                  SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
                  TO_EMAIL: ${{ github.event.inputs.recipient || secrets.TO_EMAIL }}
              run: |
                  python analytics/reporting/generate_dashboard_email.py \
                    --send-email \
                    --to "$TO_EMAIL" \
                    --subject "Relat√≥rio Di√°rio ‚Äî $(date +'%d/%m/%Y')" \
                    --metrics data/dashboard_metrics.json \
                    --alerts data/dashboard_alerts.json \
                    --actions data/dashboard_actions.json

            - name: Enviar relat√≥rio semanal
              if: github.event.schedule == '0 9 * * 1' || github.event.inputs.report_type == 'semanal'
              env:
                  SMTP_HOST: ${{ secrets.SMTP_HOST }}
                  SMTP_PORT: ${{ secrets.SMTP_PORT }}
                  SMTP_USER: ${{ secrets.SMTP_USER }}
                  SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
                  TO_EMAIL: ${{ github.event.inputs.recipient || secrets.TO_EMAIL }}
              run: |
                  python analytics/reporting/generate_dashboard_email.py \
                    --send-email \
                    --to "$TO_EMAIL" \
                    --subject "Relat√≥rio Executivo Semanal ‚Äî Semana $(date +'%V/%Y')" \
                    --metrics data/dashboard_metrics.json \
                    --alerts data/dashboard_alerts.json \
                    --actions data/dashboard_actions.json

            - name: Upload artefatos
              uses: actions/upload-artifact@v4
              with:
                  name: relatorio-${{ github.run_number }}
                  path: |
                      out/executive_email.md
                      out/executive_email.html
                  retention-days: 30
